import { createStorageAdapter } from "./storage/resolver";
import { writeToolResultsToStorageStrategy, } from "./strategies/writeToolResultsToStorage";
/**
 * Compact a sequence of messages by writing large tool outputs to a configured storage and
 * replacing them with succinct references, keeping your model context lean.
 */
export async function compactMessages(messages, options = {}) {
    const strategy = options.strategy ?? "write-tool-results-to-storage";
    // Default: compact only since the last assistant/user text turn
    const boundary = options.boundary ?? "since-last-assistant-or-user-text";
    const adapter = createStorageAdapter(options.storage);
    const serializeResult = options.serializeResult ?? ((v) => JSON.stringify(v, null, 2));
    switch (strategy) {
        case "write-tool-results-to-storage":
            return await writeToolResultsToStorageStrategy(messages, {
                boundary,
                adapter,
                serializeResult,
                storageReaderToolNames: [
                    "readFile",
                    "grepAndSearchFile",
                    ...(options.storageReaderToolNames ?? []),
                ],
            });
        default:
            throw new Error(`Unknown compaction strategy: ${strategy}`);
    }
}
